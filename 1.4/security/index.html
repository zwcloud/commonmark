




<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <meta name="description" content="How to configure league/commonmark against possible security issues when handling untrusted user input">
    
    <meta name="docsearch:version" content="1.4">
    
        <title>Security - CommonMark for PHP</title>
    
    <link rel="icon" type="image/x-icon" href="//theme.thephpleague.com/img/favicon.ico" />
    <link rel="apple-touch-icon-precomposed" href="//theme.thephpleague.com/img/apple-touch-icon-precomposed.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@thephpleague" />
    <meta name="twitter:creator" content="@colinodell" />
    <meta property="og:url" content="https://commonmark.thephpleague.com/1.4/security/" />
    
        <meta property="og:title" content="Security - CommonMark for PHP" />
    
    
        <meta property="og:description" content="How to configure league/commonmark against possible security issues when handling untrusted user input" />
    
    <meta property="og:image" content="https://commonmark.thephpleague.com/images/commonmark-social.png" />
    <link rel="stylesheet" href="//theme.thephpleague.com/css/all.css?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5">
    <link rel="stylesheet" href="/custom.css?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
    <link rel="stylesheet" href="/support.css?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137970568-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-137970568-1');
    </script>
</head>
<body>
<header>
    <div class="header-content">
        <h1 class="title">
            <a class="logo" href="/">
            <span class="name">
                <em>League\</em>CommonMark
            </span>
            </a>
        </h1>
        <div class="search"><input type="search" id="doc-search" placeholder="search the docs..."></div>
        <nav class="versions">
            <h2>v1.4 &#9662;</h2>
            <ul>
            
                <li ><a href="/2.0/">v2.0</a></li>
            
                <li class="selected"><a href="/1.4/">v1.4</a></li>
            
                <li ><a href="/1.3/">v1.3</a></li>
            
                <li ><a href="/1.0/">v1.0</a></li>
            
                <li ><a href="/0.19/">v0.19</a></li>
            
                <li ><a href="/releases/">Notes</a></li>
            </ul>
        </nav>
    </div>
</header>

<input type="checkbox" id="menu">
<label for="menu" onclick>
    <div class="closed">&#9776;</div>
    <div class="open">&#10799;</div>
</label>

<main>
    <menu>
        <div class="versions-small">
        <h2>Versions</h2>
            <ul>
        
                <li >
                    <a href="/2.0/">2.0</a>
                </li>
        
                <li class="selected">
                    <a href="/1.4/">1.4</a>
                </li>
        
                <li >
                    <a href="/1.3/">1.3</a>
                </li>
        
                <li >
                    <a href="/1.0/">1.0</a>
                </li>
        
                <li >
                    <a href="/0.19/">0.19</a>
                </li>
        
                <li ><a href="/releases/">Releases Notes</a></li>
            </ul>
        </div>

        
            
            <div class="menu-section">
                <h2>Getting Started</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/installation/">Installation</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/upgrading/">Upgrading from 1.3</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/changelog/">Changelog</a>
                        </li>
                    
                </ul>
            </div>
            
            <div class="menu-section">
                <h2>Usage</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/basic-usage/">Basic Usage</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/configuration/">Configuration</a>
                        </li>
                    
                        <li class="selected">
                            <a href="/1.4/security/">Security</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/command-line/">Command Line</a>
                        </li>
                    
                </ul>
            </div>
            
            <div class="menu-section">
                <h2>Extensions</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/extensions/overview/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/commonmark/">CommonMark</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/github-flavored-markdown/">Github-Flavored Markdown</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/autolinks/">Autolinks</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/disallowed-raw-html/">Disallowed Raw HTML</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/external-links/">External Links</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/heading-permalinks/">Heading Permalinks</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/inlines-only/">Inlines Only</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/smart-punctuation/">Smart Punctuation</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/strikethrough/">Strikethrough</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/table-of-contents/">Table of Contents</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/tables/">Tables</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/task-lists/">Task Lists</a>
                        </li>
                    
                </ul>
            </div>
            
            <div class="menu-section">
                <h2>Customization</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/customization/overview/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/environment/">Environment</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/extensions/">Extensions</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/event-dispatcher/">Event Dispatcher</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/cursor/">Cursor</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/block-parsing/">Block Parsing</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/inline-parsing/">Inline Parsing</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/delimiter-processing/">Delimiter Processing</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/abstract-syntax-tree/">Abstract Syntax Tree</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/block-rendering/">Block Rendering</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/inline-rendering/">Inline Rendering</a>
                        </li>
                    
                </ul>
            </div>
            
        
    </menu>
    <article>
    

    

    

        <h1 id="security">Security</h1>

<p>In order to be fully compliant with the CommonMark spec, certain security settings are disabled by default.  You will want to configure these settings if untrusted users will be providing the Markdown content:</p>

<ul>
  <li><code class="highlighter-rouge">html_input</code>: How to handle raw HTML</li>
  <li><code class="highlighter-rouge">allow_unsafe_links</code>: Whether unsafe links are permitted</li>
  <li><code class="highlighter-rouge">max_nesting_level</code>: Protected against long render times or segfaults</li>
</ul>

<p>Further information about each option can be found below.</p>

<h2 id="html-input">HTML Input</h2>

<p><strong>All HTML input is unescaped by default.</strong>  This behavior ensures that league/commonmark is 100% compliant with the CommonMark spec.</p>

<p>If you’re developing an application which renders user-provided Markdown from potentially untrusted users, you are <strong>strongly</strong> encouraged to set the <code class="highlighter-rouge">html_input</code> option in your configuration to either <code class="highlighter-rouge">escape</code> or <code class="highlighter-rouge">strip</code>:</p>

<h3 id="example---escape-all-raw-html-input">Example - Escape all raw HTML input:</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nn">League\CommonMark\CommonMarkConverter</span><span class="p">;</span>

<span class="nv">$converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CommonMarkConverter</span><span class="p">([</span><span class="s1">'html_input'</span> <span class="o">=&gt;</span> <span class="s1">'escape'</span><span class="p">]);</span>
<span class="k">echo</span> <span class="nv">$converter</span><span class="o">-&gt;</span><span class="na">convertToHtml</span><span class="p">(</span><span class="s1">'&lt;script&gt;alert("Hello XSS!");&lt;/script&gt;'</span><span class="p">);</span>

<span class="c1">// &amp;lt;script&amp;gt;alert("Hello XSS!");&amp;lt;/script&amp;gt;</span>
</code></pre></div></div>

<h3 id="example---strip-all-html-from-the-input">Example - Strip all HTML from the input:</h3>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nn">League\CommonMark\CommonMarkConverter</span><span class="p">;</span>

<span class="nv">$converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CommonMarkConverter</span><span class="p">([</span><span class="s1">'html_input'</span> <span class="o">=&gt;</span> <span class="s1">'strip'</span><span class="p">]);</span>
<span class="k">echo</span> <span class="nv">$converter</span><span class="o">-&gt;</span><span class="na">convertToHtml</span><span class="p">(</span><span class="s1">'&lt;script&gt;alert("Hello XSS!");&lt;/script&gt;'</span><span class="p">);</span>

<span class="c1">// (empty output)</span>
</code></pre></div></div>

<p><strong>Failing to set this option could make your site vulnerable to cross-site scripting (XSS) attacks!</strong></p>

<p>See the <a href="/1.4/configuration/">configuration</a> section for more information.</p>

<h2 id="unsafe-links">Unsafe Links</h2>

<p>Unsafe links are also allowed by default due to CommonMark spec compliance.  An unsafe link is one that uses any of these protocols:</p>

<ul>
  <li><code class="highlighter-rouge">javascript:</code></li>
  <li><code class="highlighter-rouge">vbscript:</code></li>
  <li><code class="highlighter-rouge">file:</code></li>
  <li><code class="highlighter-rouge">data:</code> (except for <code class="highlighter-rouge">data:image</code> in png, gif, jpeg, or webp format)</li>
</ul>

<p>To prevent these from being parsed and rendered, you should set the <code class="highlighter-rouge">allow_unsafe_links</code> option to <code class="highlighter-rouge">false</code>.</p>

<h2 id="nesting-level">Nesting Level</h2>

<p><strong>No maximum nesting level is enforced by default.</strong>  Markdown content which is too deeply-nested (like 10,000 nested blockquotes: ‘&gt; &gt; &gt; &gt; &gt; …’) <a href="https://github.com/thephpleague/commonmark/issues/243#issuecomment-217580285">could result in long render times or segfaults</a>.</p>

<p>If you need to parse untrusted input, consider setting a reasonable <code class="highlighter-rouge">max_nesting_level</code> (perhaps 10-50) depending on your needs.  Once this nesting level is hit, any subsequent Markdown will be rendered as plain text.</p>

<h3 id="example---prevent-deep-nesting">Example - Prevent deep nesting</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nn">League\CommonMark\CommonMarkConverter</span><span class="p">;</span>

<span class="nv">$markdown</span> <span class="o">=</span> <span class="nb">str_repeat</span><span class="p">(</span><span class="s1">'&gt; '</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' Foo'</span><span class="p">;</span>

<span class="nv">$converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CommonMarkConverter</span><span class="p">([</span><span class="s1">'max_nesting_level'</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">]);</span>
<span class="k">echo</span> <span class="nv">$converter</span><span class="o">-&gt;</span><span class="na">convertToHtml</span><span class="p">(</span><span class="nv">$markdown</span><span class="p">);</span>

<span class="c1">// &lt;blockquote&gt;</span>
<span class="c1">//   &lt;blockquote&gt;</span>
<span class="c1">//     &lt;blockquote&gt;</span>
<span class="c1">//       &lt;blockquote&gt;</span>
<span class="c1">//         &lt;blockquote&gt;</span>
<span class="c1">//           &lt;p&gt;&amp;gt; &amp;gt; &amp;gt; &amp;gt; &amp;gt; &amp;gt; &amp;gt; ... Foo&lt;/p&gt;&lt;/blockquote&gt;</span>
<span class="c1">//       &lt;/blockquote&gt;</span>
<span class="c1">//     &lt;/blockquote&gt;</span>
<span class="c1">//   &lt;/blockquote&gt;</span>
<span class="c1">// &lt;/blockquote&gt;</span>
</code></pre></div></div>

<p>See the <a href="/1.4/configuration/">configuration</a> section for more information.</p>

<h2 id="additional-filtering">Additional Filtering</h2>

<p>Although this library does offer these security features out-of-the-box, some users may opt to also run the HTML output through additional filtering layers (like HTMLPurifier).  If you do this, make sure you <strong>thoroughly</strong> test your additional post-processing steps and configure them to work properly with the types of HTML elements and attributes that converted Markdown might produce, otherwise, you may end up with weird behavior like missing images, broken links, mismatched HTML tags, etc.</p>

    </article>

    <aside class="support-banner-wrapper" x-data="{ show: false }" x-show.transition="show" x-init="h = localStorage.getItem('hideBanner'); (h === null || h < (new Date().getTime())) ? (setTimeout(() => show = true, 500)) : (show = false)" style="">
        <div class="support-banner">
            <p class="support-banner-left">
                <strong>Love PHP Commonmark?</strong>
                <span class="hidden sm:inline-block lg:hidden">
                    Show your support!
                </span>

                <span class="hidden lg:inline-block">
                    Support development via monthly sponsorship or a one-time donation!
                </span>
            </p>

            <div class="support-banner-right">
                <a href="https://www.colinodell.com/sponsor" class="support-button support-button-sponsor">
                    <i class="fas fa-heart fa-fw"></i> Sponsor
                </a>

                <a href="https://www.paypal.me/colinpodell/10.00" class="support-button support-button-donate">
                    <i class="fas fa-donate fa-fw"></i> Donate
                </a>
            </div>

            <button x-on:click="localStorage.setItem('hideBanner', new Date().getTime() + (7*24*60*60*1000)); show = false" class="support-banner-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </aside>
</main>

<footer>
    <span>&copy; Copyright <a href="https://www.colinodell.com">Colin O'Dell</a> &amp; <a href="//thephpleague.com">The League of Extraordinary Packages</a>.</span>
    <span>Site design by <a href="//reinink.ca">Jonathan Reinink</a> and <a href="//nyamsprod.com">Ignace Nyamagana Butera</a>.</span>
</footer>
<script src="/custom.js?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5"></script>
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
<script> docsearch({
    apiKey: '8f6d6eb939fe0df83616a0bb240332c8',
    indexName: 'commonmark-thephpleague',
    inputSelector: '#doc-search',
    algoliaOptions: { 'facetFilters': ["version:1.4"] },
    debug: false // Set debug to true if you want to inspect the dropdown
});
</script>
</body>
</html>
