




<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <meta name="description" content="How to leverage the event dispatcher to hook into the library">
    
    <meta name="docsearch:version" content="1.4">
    
        <title>Event Dispatcher - CommonMark for PHP</title>
    
    <link rel="icon" type="image/x-icon" href="//theme.thephpleague.com/img/favicon.ico" />
    <link rel="apple-touch-icon-precomposed" href="//theme.thephpleague.com/img/apple-touch-icon-precomposed.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@thephpleague" />
    <meta name="twitter:creator" content="@colinodell" />
    <meta property="og:url" content="https://commonmark.thephpleague.com/1.4/customization/event-dispatcher/" />
    
        <meta property="og:title" content="Event Dispatcher - CommonMark for PHP" />
    
    
        <meta property="og:description" content="How to leverage the event dispatcher to hook into the library" />
    
    <meta property="og:image" content="https://commonmark.thephpleague.com/images/commonmark-social.png" />
    <link rel="stylesheet" href="//theme.thephpleague.com/css/all.css?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5">
    <link rel="stylesheet" href="/custom.css?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
    <link rel="stylesheet" href="/support.css?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137970568-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-137970568-1');
    </script>
</head>
<body>
<header>
    <div class="header-content">
        <h1 class="title">
            <a class="logo" href="/">
            <span class="name">
                <em>League\</em>CommonMark
            </span>
            </a>
        </h1>
        <div class="search"><input type="search" id="doc-search" placeholder="search the docs..."></div>
        <nav class="versions">
            <h2>v1.4 &#9662;</h2>
            <ul>
            
                <li ><a href="/2.0/">v2.0</a></li>
            
                <li class="selected"><a href="/1.4/">v1.4</a></li>
            
                <li ><a href="/1.3/">v1.3</a></li>
            
                <li ><a href="/1.0/">v1.0</a></li>
            
                <li ><a href="/0.19/">v0.19</a></li>
            
                <li ><a href="/releases/">Notes</a></li>
            </ul>
        </nav>
    </div>
</header>

<input type="checkbox" id="menu">
<label for="menu" onclick>
    <div class="closed">&#9776;</div>
    <div class="open">&#10799;</div>
</label>

<main>
    <menu>
        <div class="versions-small">
        <h2>Versions</h2>
            <ul>
        
                <li >
                    <a href="/2.0/">2.0</a>
                </li>
        
                <li class="selected">
                    <a href="/1.4/">1.4</a>
                </li>
        
                <li >
                    <a href="/1.3/">1.3</a>
                </li>
        
                <li >
                    <a href="/1.0/">1.0</a>
                </li>
        
                <li >
                    <a href="/0.19/">0.19</a>
                </li>
        
                <li ><a href="/releases/">Releases Notes</a></li>
            </ul>
        </div>

        
            
            <div class="menu-section">
                <h2>Getting Started</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/installation/">Installation</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/upgrading/">Upgrading from 1.3</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/changelog/">Changelog</a>
                        </li>
                    
                </ul>
            </div>
            
            <div class="menu-section">
                <h2>Usage</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/basic-usage/">Basic Usage</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/configuration/">Configuration</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/security/">Security</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/command-line/">Command Line</a>
                        </li>
                    
                </ul>
            </div>
            
            <div class="menu-section">
                <h2>Extensions</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/extensions/overview/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/commonmark/">CommonMark</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/github-flavored-markdown/">Github-Flavored Markdown</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/autolinks/">Autolinks</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/disallowed-raw-html/">Disallowed Raw HTML</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/external-links/">External Links</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/heading-permalinks/">Heading Permalinks</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/inlines-only/">Inlines Only</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/smart-punctuation/">Smart Punctuation</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/strikethrough/">Strikethrough</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/table-of-contents/">Table of Contents</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/tables/">Tables</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/extensions/task-lists/">Task Lists</a>
                        </li>
                    
                </ul>
            </div>
            
            <div class="menu-section">
                <h2>Customization</h2>
                <ul>
                    
                        <li >
                            <a href="/1.4/customization/overview/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/environment/">Environment</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/extensions/">Extensions</a>
                        </li>
                    
                        <li class="selected">
                            <a href="/1.4/customization/event-dispatcher/">Event Dispatcher</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/cursor/">Cursor</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/block-parsing/">Block Parsing</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/inline-parsing/">Inline Parsing</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/delimiter-processing/">Delimiter Processing</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/abstract-syntax-tree/">Abstract Syntax Tree</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/block-rendering/">Block Rendering</a>
                        </li>
                    
                        <li >
                            <a href="/1.4/customization/inline-rendering/">Inline Rendering</a>
                        </li>
                    
                </ul>
            </div>
            
        
    </menu>
    <article>
    

    

    

        <h1 id="event-dispatcher">Event Dispatcher</h1>

<p>This library includes basic event dispatcher functionality.  This makes it possible to add hook points throughout the library and third-party extensions which other code can listen for and execute code.  If you’re familiar with <a href="https://symfony.com/doc/current/components/event_dispatcher.html">Symfony’s EventDispatcher</a> or <a href="https://www.php-fig.org/psr/psr-14/">PSR-14</a> then this should be very familiar to you.</p>

<h2 id="event-class">Event Class</h2>

<p>All events must extend from the <code class="highlighter-rouge">AbstractEvent</code> class:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nn">League\CommonMark\Event\AbstractEvent</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyCustomEvent</span> <span class="k">extends</span> <span class="nx">AbstractEvent</span> <span class="p">{}</span>
</code></pre></div></div>

<p>An event can have any number of methods on it which return useful information the listeners can use or modify.</p>

<h2 id="registering-listeners">Registering Listeners</h2>

<p>Listeners can be registered with the <code class="highlighter-rouge">Environment</code> using the <code class="highlighter-rouge">addEventListener()</code> method:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="nf">addEventListener</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$eventClass</span><span class="p">,</span> <span class="kt">callable</span> <span class="nv">$listener</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>The parameters for this method are:</p>

<ol>
  <li>The fully-qualified name of the event class you wish to observe</li>
  <li>Any <a href="https://www.php.net/manual/en/language.types.callable.php">PHP callable</a> to execute when that type of event is dispatched</li>
  <li>An optional priority (defaults to <code class="highlighter-rouge">0</code>)</li>
</ol>

<p>For example:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Telling the environment which method to call:</span>
<span class="nv">$customListener</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyCustomListener</span><span class="p">();</span>
<span class="nv">$environment</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span><span class="nx">MyCustomEvent</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span><span class="nv">$customListener</span><span class="p">,</span> <span class="s1">'onDocumentParsed'</span><span class="p">]);</span>

<span class="c1">// Or if MyCustomerListener has an __invoke() method:</span>
<span class="nv">$environment</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span><span class="nx">MyCustomEvent</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">new</span> <span class="nx">MyCustomListener</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>

<span class="c1">// Or use any other type of callable you wish!</span>
<span class="nv">$environment</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span><span class="nx">MyCustomEvent</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">MyCustomEvent</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO: Stuff</span>
<span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="dispatching-events">Dispatching Events</h2>

<p>Events can be dispatched via the <code class="highlighter-rouge">$environment-&gt;dispatch()</code> method which takes a single argument - an instance of <code class="highlighter-rouge">AbstractEvent</code> to dispatch:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$environment</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyCustomEvent</span><span class="p">());</span>
</code></pre></div></div>

<p>Listeners will be called in order of priority (higher priorities will be called first).  If multiple listeners have the same priority, they’ll be called in the order in which they were registered.  If you’d like your listener to prevent other subsequent events from running, simply call <code class="highlighter-rouge">$event-&gt;stopPropagation()</code>.</p>

<p>Listeners may call any method on the event to get more information about the event, make changes to event data, etc.</p>

<h2 id="list-of-available-events">List of Available Events</h2>

<p>This library supports the following default events which you can register listeners for:</p>

<h3 id="leaguecommonmarkeventdocumentpreparsedevent"><code class="highlighter-rouge">League\CommonMark\Event\DocumentPreParsedEvent</code></h3>

<p>This event is dispatched just before any processing is done. It can be used to pre-populate reference map of a document or manipulate the Markdown contents before any processing is performed.</p>

<h3 id="leaguecommonmarkeventdocumentparsedevent"><code class="highlighter-rouge">League\CommonMark\Event\DocumentParsedEvent</code></h3>

<p>This event is dispatched once all other processing is done.  This offers extensions the opportunity to inspect and modify the <a href="/1.4/customization/abstract-syntax-tree/">Abstract Syntax Tree</a> prior to rendering.</p>

<h2 id="example">Example</h2>

<p>Here’s an example of a listener which uses the <code class="highlighter-rouge">DocumentParsedEvent</code> to add an <code class="highlighter-rouge">external-link</code> class to external URLs:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nn">League\CommonMark\EnvironmentInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">League\CommonMark\Event\DocumentParsedEvent</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">League\CommonMark\Inline\Element\Link</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ExternalLinkProcessor</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$environment</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">EnvironmentInterface</span> <span class="nv">$environment</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span> <span class="o">=</span> <span class="nv">$environment</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">onDocumentParsed</span><span class="p">(</span><span class="nx">DocumentParsedEvent</span> <span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$document</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getDocument</span><span class="p">();</span>
        <span class="nv">$walker</span> <span class="o">=</span> <span class="nv">$document</span><span class="o">-&gt;</span><span class="na">walker</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$event</span> <span class="o">=</span> <span class="nv">$walker</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getNode</span><span class="p">();</span>

            <span class="c1">// Only stop at Link nodes when we first encounter them</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nb">Link</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">isEntering</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">getUrl</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isUrlExternal</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'attributes'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'external-link'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">isUrlExternal</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$url</span><span class="p">)</span><span class="o">:</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="c1">// Only look at http and https URLs</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^https?:\/\//'</span><span class="p">,</span> <span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$host</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="kc">PHP_URL_HOST</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$host</span> <span class="o">!=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="o">-&gt;</span><span class="na">getConfig</span><span class="p">(</span><span class="s1">'host'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s how you’d use it:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nn">League\CommonMark\CommonMarkConverter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">League\CommonMark\Environment</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">League\CommonMark\Event\DocumentParsedEvent</span><span class="p">;</span>

<span class="nv">$env</span> <span class="o">=</span> <span class="nx">Environment</span><span class="o">::</span><span class="na">createCommonMarkEnvironment</span><span class="p">();</span>

<span class="nv">$listener</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExternalLinkProcessor</span><span class="p">(</span><span class="nv">$env</span><span class="p">);</span>
<span class="nv">$env</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span><span class="nx">DocumentParsedEvent</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span><span class="nv">$listener</span><span class="p">,</span> <span class="s1">'onDocumentParsed'</span><span class="p">]);</span>

<span class="nv">$converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CommonMarkConverter</span><span class="p">([</span><span class="s1">'host'</span> <span class="o">=&gt;</span> <span class="s1">'commonmark.thephpleague.com'</span><span class="p">],</span> <span class="nv">$env</span><span class="p">);</span>

<span class="nv">$input</span> <span class="o">=</span> <span class="s1">'My two favorite sites are &lt;https://google.com&gt; and &lt;https://commonmark.thephpleague.com&gt;'</span><span class="p">;</span>

<span class="k">echo</span> <span class="nv">$converter</span><span class="o">-&gt;</span><span class="na">convertToHtml</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>
</code></pre></div></div>

<p>Output (formatted for readability):</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>
    My two favorite sites are
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"external-link"</span> <span class="na">href=</span><span class="s">"https://google.com"</span><span class="nt">&gt;</span>https://google.com<span class="nt">&lt;/a&gt;</span>
    and
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://commonmark.thephpleague.com"</span><span class="nt">&gt;</span>https://commonmark.thephpleague.com<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>

    </article>

    <aside class="support-banner-wrapper" x-data="{ show: false }" x-show.transition="show" x-init="h = localStorage.getItem('hideBanner'); (h === null || h < (new Date().getTime())) ? (setTimeout(() => show = true, 500)) : (show = false)" style="">
        <div class="support-banner">
            <p class="support-banner-left">
                <strong>Love PHP Commonmark?</strong>
                <span class="hidden sm:inline-block lg:hidden">
                    Show your support!
                </span>

                <span class="hidden lg:inline-block">
                    Support development via monthly sponsorship or a one-time donation!
                </span>
            </p>

            <div class="support-banner-right">
                <a href="https://www.colinodell.com/sponsor" class="support-button support-button-sponsor">
                    <i class="fas fa-heart fa-fw"></i> Sponsor
                </a>

                <a href="https://www.paypal.me/colinpodell/10.00" class="support-button support-button-donate">
                    <i class="fas fa-donate fa-fw"></i> Donate
                </a>
            </div>

            <button x-on:click="localStorage.setItem('hideBanner', new Date().getTime() + (7*24*60*60*1000)); show = false" class="support-banner-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </aside>
</main>

<footer>
    <span>&copy; Copyright <a href="https://www.colinodell.com">Colin O'Dell</a> &amp; <a href="//thephpleague.com">The League of Extraordinary Packages</a>.</span>
    <span>Site design by <a href="//reinink.ca">Jonathan Reinink</a> and <a href="//nyamsprod.com">Ignace Nyamagana Butera</a>.</span>
</footer>
<script src="/custom.js?31f91fcbc2e49e8a1d9ed776d72d6de7457566f5"></script>
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
<script> docsearch({
    apiKey: '8f6d6eb939fe0df83616a0bb240332c8',
    indexName: 'commonmark-thephpleague',
    inputSelector: '#doc-search',
    algoliaOptions: { 'facetFilters': ["version:1.4"] },
    debug: false // Set debug to true if you want to inspect the dropdown
});
</script>
</body>
</html>
